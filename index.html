<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nova Foundry</title>
<link rel="icon" type="image/x-icon" href="Images/Nova_foundry_favicon.ico" />
<link rel="stylesheet" href="style.css" />
<style>
body { margin:0; font-family: Arial, sans-serif; color: #fff; background: #000; }
.container { display: flex; flex-direction: row; padding: 20px; z-index: 10; position: relative; }
.left-panel { flex: 1; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; max-width: 95%;}
.logo-small { max-width: 100%; height: auto; margin-bottom: 20px; }
.readme { max-width: 100%; }
.right-panel { flex: 2; display: flex; flex-direction: column; gap: 10px; }
.project-card { margin-bottom: 20px; padding: 15px; border-radius: 10px; background: rgba(255,255,255,0.05); }
.project-card h3 { margin: 0 0 10px; }
.repo-info { display: flex; gap: 10px; flex-wrap: wrap; line-height: 3px;}
.toggle-readme { padding: 5px 10px; border-radius: 5px; background-color: #444; color: #fff; border: none; cursor: pointer; }
.toggle-readme:hover { background-color: #666; }
.project-card a { color: #fff; text-decoration: none; margin-top: 10px; display: inline-block; }
.project-card a:hover { text-decoration: underline; }
canvas { position: fixed; top:0; left:0; z-index:0; }

.tabs { display: flex; gap: 10px; margin-bottom: 20px; }
.tabs button { padding: 10px 20px; background: rgba(255,255,255,0.1); color: #fff; border: none; border-radius: 5px; cursor: pointer; }
.tabs button:hover { background: rgba(255,255,255,0.2); }
.tabs button.active { background: rgba(255,255,255,0.3); }

@media (max-width: 768px) {
    .container { flex-direction: column; }
    .left-panel { margin-right: 0; margin-bottom: 20px; width: 100%; }
    .right-panel { width: 100%; flex: none; }
}
</style>
</head>
<body>
<canvas id="starCanvas"></canvas>

<div class="container">
    <div class="left-panel">
        <img class="logo-small" src="Images/Nova_foundry_wide_transparent.png" alt="Nova Foundry Image" />
        <div id="readmeContent" class="readme"></div>
    </div>
    <div class="right-panel">
        <div class="tabs">
            <button class="tab active" data-tab="home">Home</button>
            <button class="tab" data-tab="github">GitHub Repos</button>
            <button class="tab" data-tab="itch">itch.io Projects</button>
        </div>
        <div class="tab-contents">
            <div id="home" class="tab-content"></div>
            <div id="github" class="tab-content" style="display: none;"></div>
            <div id="itch" class="tab-content" style="display: none;"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const canvas = document.getElementById('starCanvas');
const ctx = canvas.getContext('2d');
let stars=[], galaxies=[], shootingStars=[];
let mouseX=0, mouseY=0;
const githubUsername = "directedhunt42";
const itchCollectionUrl = "https://itch.io/c/6591033/nova-foundrys-collection";
const proxyUrl = "https://api.allorigins.win/raw?url=";

// ===== STARFIELD, GALAXIES, SHOOTING STARS =====
function resizeCanvas() { canvas.width=window.innerWidth; canvas.height=window.innerHeight; generateStars(); generateGalaxies(); }

function generateStars() {
    stars=[];
    const starCount=400;
    const colors=['#ffffff','#ffd700','#add8e6','#ffcccb'];
    for(let i=0;i<starCount;i++){stars.push({
        x:Math.random()*canvas.width,
        y:Math.random()*canvas.height,
        radius:Math.random()*1.5+0.5,
        color:colors[Math.floor(Math.random()*colors.length)],
        driftX:Math.random()*0.02-0.01,
        driftY:Math.random()*0.02-0.01,
        parallax:0.01+Math.random()*0.04
    });}
}

function generateGalaxies(){
    galaxies=[];
    const galaxyCount=6;
    const colors=['#ffffff','#ffd700','#add8e6','#ffcccb'];
    for(let g=0;g<galaxyCount;g++){
        const centerX=Math.random()*canvas.width;
        const centerY=Math.random()*canvas.height;
        const radiusX=30+Math.random()*70;
        const radiusY=20+Math.random()*50;
        const rotationSpeed=0.0001+Math.random()*0.001;
        const tilt=(Math.random()*40-20)*Math.PI/180;
        const angleOffset=Math.random()*2*Math.PI;
        const arms=3+Math.floor(Math.random()*2);
        const starsInGalaxy=[];
        for(let i=0;i<50;i++){
            const arm=i%arms;
            const radiusFactor=Math.random();
            const angle=radiusFactor*4*Math.PI + arm*2*Math.PI/arms + angleOffset;
            starsInGalaxy.push({
                angle, radiusX, radiusY, centerX, centerY, tilt, armAngleOffset:arm*2*Math.PI/arms,
                radius:Math.random()*1.2+0.3,
                color:colors[Math.floor(Math.random()*colors.length)],
                speed:rotationSpeed,
                parallax:0.02+Math.random()*0.03,
                driftX:Math.random()*0.01-0.005,
                driftY:Math.random()*0.01-0.005,
                radiusFactor
            });
        }
        galaxies.push(starsInGalaxy);
    }
}

function generateShootingStar(){shootingStars.push({
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height/2,
    speedX:20+Math.random()*30,
    speedY:5+Math.random()*5,
    length:100+Math.random()*50,
    color:'#ffffff',
    parallax:0.02+Math.random()*0.03
});}

function drawStars(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    stars.forEach(s=>{
        s.x+=s.driftX;s.y+=s.driftY;
        if(s.x<0)s.x=canvas.width;if(s.x>canvas.width)s.x=0;
        if(s.y<0)s.y=canvas.height;if(s.y>canvas.height)s.y=0;
        const dx=(mouseX-canvas.width/2)*s.parallax;
        const dy=(mouseY-canvas.height/2)*s.parallax;
        ctx.beginPath();ctx.arc(s.x+dx,s.y+dy,s.radius,0,2*Math.PI);ctx.fillStyle=s.color;ctx.fill();
    });
    galaxies.forEach(g=>g.forEach(star=>{
        star.angle+=star.speed;
        const x0=star.centerX+star.radiusX*star.radiusFactor*Math.cos(star.angle+star.armAngleOffset);
        const y0=star.centerY+star.radiusY*star.radiusFactor*Math.sin(star.angle+star.armAngleOffset)*Math.cos(star.tilt);
        star.x0=x0+star.driftX;star.y0=y0+star.driftY;
        const dx=(mouseX-canvas.width/2)*star.parallax;
        const dy=(mouseY-canvas.height/2)*star.parallax;
        ctx.beginPath();ctx.ellipse(star.x0+dx,star.y0+dy,star.radius*1.2,star.radius,0,0,2*Math.PI);ctx.fillStyle=star.color;ctx.fill();
    }));
    shootingStars.forEach((s,i)=>{
        s.x+=s.speedX;s.y+=s.speedY;
        const dx=(mouseX-canvas.width/2)*s.parallax;
        const dy=(mouseY-canvas.height/2)*s.parallax;
        const angle=Math.atan2(s.speedY,s.speedX);
        ctx.save();ctx.translate(s.x+dx,s.y+dy);ctx.rotate(angle);
        ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(-s.length,0);ctx.strokeStyle=s.color;ctx.lineWidth=2;ctx.stroke();ctx.restore();
        if(s.x-s.length>canvas.width||s.y-s.length/2>canvas.height){shootingStars.splice(i,1);}
    });
    requestAnimationFrame(drawStars);
}

window.addEventListener('resize',resizeCanvas);
resizeCanvas();drawStars();
setInterval(()=>{if(Math.random()<0.05)generateShootingStar();},2000);

// Mobile detection and input handling for parallax
const isMobile = /Mobi|Android/i.test(navigator.userAgent);

function addOrientationListener() {
  window.addEventListener('deviceorientation', (event) => {
    // Map device tilt to simulated mouse position
    // Adjust the divisor (180) for sensitivity: smaller number = more sensitive
    mouseX = (window.innerWidth / 2) - (event.gamma * (window.innerWidth / 180));
    mouseY = (window.innerHeight / 2) - (event.beta * (window.innerHeight / 180));
    // Clamp to screen bounds to mimic mouse
    mouseX = Math.max(0, Math.min(window.innerWidth, mouseX));
    mouseY = Math.max(0, Math.min(window.innerHeight, mouseY));
  });
}

if (isMobile && window.DeviceOrientationEvent) {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    // iOS 13+: Request permission on user interaction (touchstart)
    document.addEventListener('touchstart', async () => {
      try {
        const permission = await DeviceOrientationEvent.requestPermission();
        if (permission === 'granted') {
          addOrientationListener();
        }
      } catch (err) {
        console.error('Device orientation permission error:', err);
      }
    }, { once: true });
  } else {
    // Android and other devices: Add listener directly
    addOrientationListener();
  }
} else {
  // Desktop: Use mouse position
  window.addEventListener('mousemove', (e) => {
    mouseX = e.clientX;
    mouseY = e.clientY;
  });
}

// ===== LOAD LOCAL MAIN README =====
fetch('README.md').then(res=>res.text()).then(md=>{
    document.getElementById('readmeContent').innerHTML=marked.parse(md);
}).catch(()=>document.getElementById('readmeContent').innerHTML='<p>Could not load README.md</p>');

// ===== TABS FUNCTIONALITY =====
const tabs = document.querySelectorAll('.tab');
tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById(tab.dataset.tab).style.display = 'block';
    });
});

// ===== LOAD GITHUB REPOS =====
fetch(`https://api.github.com/users/${githubUsername}/repos`).then(res=>res.json()).then(async repos=>{
    const filteredRepos = repos.filter(r=>r.name!=='directedhunt42.github.io');
    const homeContainer = document.getElementById('home');
    const githubContainer = document.getElementById('github');
    for(const r of filteredRepos){
        const card = document.createElement('div');
        card.className = 'project-card fade-in';
        card.innerHTML = `
            <h3>${r.name}</h3>
            <div class='repo-info'>
                <p>‚≠ê Stars: ${r.stargazers_count}</p>
                <p>ü™≤ Issues: ${r.open_issues_count}</p>
                <p>üì¶ Size: ${(r.size/1024).toFixed(2)} MB</p>
                <p>üïí Updated: ${new Date(r.updated_at).toLocaleDateString()}</p>
                <p>üå± Forks: ${r.forks_count}</p>
            </div>
            <button class='toggle-readme'>Show README</button>
            <div class='repo-readme' style='display:none;'></div>
            <a href='${r.html_url}' target='_blank'>View on GitHub</a>`;
        const readmeDiv = card.querySelector('.repo-readme');
        const toggleBtn = card.querySelector('.toggle-readme');

        const tagsRes = await fetch(`https://api.github.com/repos/${githubUsername}/${r.name}/tags`);
        const tags = await tagsRes.json();
        if(tags.length){const tagEl=document.createElement('p');tagEl.textContent=`üè∑Ô∏è Latest Tag: ${tags[0].name}`;card.querySelector('.repo-info').appendChild(tagEl);}

        toggleBtn.addEventListener('click', async () => {
            if(readmeDiv.style.display === 'none'){
                if(!readmeDiv.innerHTML){
                    try{
                        const readmeRes = await fetch(`https://raw.githubusercontent.com/${githubUsername}/${r.name}/main/README.md`);
                        const md = await readmeRes.text();
                        readmeDiv.innerHTML = marked.parse(md);
                    }catch(e){readmeDiv.innerHTML = '<p>No README found</p>';}
                }
                readmeDiv.style.display = 'block';
                toggleBtn.textContent = 'Hide README';
            } else {
                readmeDiv.style.display = 'none';
                toggleBtn.textContent = 'Show README';
            }
        });

        githubContainer.appendChild(card);
    }

    // Add top 4 GitHub to home
    for (let i = 0; i < Math.min(4, filteredRepos.length); i++) {
        const r = filteredRepos[i];
        const card = githubContainer.children[i].cloneNode(true);
        card.querySelector('.toggle-readme').remove();
        card.querySelector('.repo-readme').remove();
        homeContainer.appendChild(card);
    }
    homeContainer.offsetHeight; // Force reflow

    // Add horizontal line
    const hr = document.createElement('hr');
    homeContainer.appendChild(hr);
    homeContainer.offsetHeight; // Force reflow

    // ===== LOAD ITCH.IO PROJECTS FROM COLLECTION =====
    fetch(proxyUrl + encodeURIComponent(itchCollectionUrl))
        .then(res => res.text())
        .then(async html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const games = doc.querySelectorAll('.game_cell');
            const itchContainer = document.getElementById('itch');
            for (const game of Array.from(games)) {
                const titleEl = game.querySelector('.game_title a');
                const title = titleEl ? titleEl.textContent.trim() : 'Unknown Title';
                const link = titleEl ? titleEl.href : '#';
                const descEl = game.querySelector('.game_text');
                const desc = descEl ? descEl.textContent.trim() : 'No description available';
                const thumbEl = game.querySelector('.game_thumb img');
                const thumb = thumbEl ? (thumbEl.src || thumbEl.dataset.lazySrc) : '';

                // Fetch project page for stats
                let ratingsCount = 'N/A';
                let averageRating = 'N/A';
                try {
                    const projectRes = await fetch(proxyUrl + encodeURIComponent(link));
                    const projectHtml = await projectRes.text();
                    const projectDoc = parser.parseFromString(projectHtml, 'text/html');
                    const ratingCountEl = projectDoc.querySelector('.rating_count');
                    ratingsCount = ratingCountEl ? ratingCountEl.textContent.trim().replace(/[^\d]/g, '') : 'N/A';
                    const aggregateRatingEl = projectDoc.querySelector('.aggregate_rating');
                    averageRating = aggregateRatingEl ? aggregateRatingEl.textContent.trim() : 'N/A';
                } catch (e) {
                    console.error('Error fetching project stats:', e);
                }

                const card = document.createElement('div');
                card.className = 'project-card fade-in';
                let innerHTML = `
                    <h3>${title}</h3>
                    <div class='repo-info'>
                        <p>‚≠ê Rating: ${averageRating} (${ratingsCount} ratings)</p>
                    </div>
                    <p>${desc}</p>
                    <a href='${link}' target='_blank'>View on itch.io</a>`;
                if (thumb) {
                    innerHTML = `<img src="${thumb}" alt="${title} thumbnail" style="max-width: 100%; border-radius: 5px; margin-bottom: 10px;">` + innerHTML;
                }
                card.innerHTML = innerHTML;

                itchContainer.appendChild(card);
            }

            // Add top 4 itch to home
            for (let i = 0; i < Math.min(4, games.length); i++) {
                const card = itchContainer.children[i].cloneNode(true);
                homeContainer.appendChild(card);
            }
            homeContainer.offsetHeight; // Force reflow

            // Force full reflow on home tab
            homeContainer.style.display = 'none';
            homeContainer.offsetHeight;
            homeContainer.style.display = 'block';
        })
        .catch(err => console.error('Error loading itch.io projects:', err));
});
</script>
</body>
</html>